name: Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.build
          push: false
          load: true
          tags: confd:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test - Version check
        run: |
          docker run --rm confd:test --version

      - name: Test - Help output
        run: |
          docker run --rm confd:test --help

      - name: Test - Env backend with template
        run: |
          # Create test configuration
          mkdir -p test-conf/conf.d test-conf/templates test-output

          # Make output writable by container user (UID 1000)
          chmod 777 test-output

          cat > test-conf/conf.d/test.toml << 'EOF'
          [template]
          src = "test.tmpl"
          dest = "/output/test.conf"
          keys = ["/app"]
          EOF

          cat > test-conf/templates/test.tmpl << 'EOF'
          app_name = {{ getv "/app/name" }}
          app_port = {{ getv "/app/port" }}
          EOF

          # Run confd with env backend
          docker run --rm \
            -e APP_NAME=myapp \
            -e APP_PORT=8080 \
            -v $(pwd)/test-conf/conf.d:/etc/confd/conf.d:ro \
            -v $(pwd)/test-conf/templates:/etc/confd/templates:ro \
            -v $(pwd)/test-output:/output \
            confd:test env --onetime

          # Verify output
          cat test-output/test.conf
          grep -q "app_name = myapp" test-output/test.conf
          grep -q "app_port = 8080" test-output/test.conf

      - name: Test - Config validation
        run: |
          # Create valid config for check-config test
          mkdir -p check-conf/conf.d check-conf/templates

          cat > check-conf/conf.d/valid.toml << 'EOF'
          [template]
          src = "valid.tmpl"
          dest = "/tmp/valid.conf"
          keys = ["/test"]
          EOF

          cat > check-conf/templates/valid.tmpl << 'EOF'
          test = {{ getv "/test/value" }}
          EOF

          # Run config validation
          docker run --rm \
            -v $(pwd)/check-conf/conf.d:/etc/confd/conf.d:ro \
            -v $(pwd)/check-conf/templates:/etc/confd/templates:ro \
            confd:test --check-config env

  security-scan:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.build
          push: false
          load: true
          tags: confd:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'confd:scan'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
